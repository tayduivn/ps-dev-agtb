<!DOCTYPE html>
<html lang="en">
<head>
  <script src="js/jquery-1.7.2.min.js"></script>
  <script src="js/ICanHaz.min.js" ></script>
  <script src="js/styleguide.js"></script>
  <link href="css/bootstrap.css" rel="stylesheet">
  <link href="css/nv.d3.css" rel="stylesheet">
  <script>
    var page = {
        "title": "Charting"
      , "description": "Implementing standard and custom SVG charts for Sugar7 release using the <a href=\"http://d3js.org/\">D3 library</a> and the <a href=\"http://nvd3.com/\">NVD3 framework</a>."
      , "sections": ["Line","Horizontal Bar","Vertical Bar","Circular","Custom","Implementation"]
      , "sectionLink": sectionLink
      , "templates":"head,navbar,masthead,libraries"
    };
  </script>
</head>
<body data-spy="scroll" data-target=".subnav" data-offset="200" class="scroll">
<div class="container">

    <section id="line">
      <div class="page-header">
        <h2>Line <small>used for comparing data series</small></h2>
      </div>
      <div class="row">
        <div class="span6">
          <h3>Standard Line Chart</h3>
          <p>Line chart with baseline y-axis. <a href="charts/lineChart.html">Full Screen</a> with options for line interpolation and fill.</p>
          <div>
<div id="line1" class="nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
          <h3>Stacked Area Chart</h3>
          <p>Line chart with cumulative y-axis. <a href="charts/stackedAreaChart.html">Full Screen</a> showing options for cumulative scale.</p>
          <div>
<div id="area" class="nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
      </div>
    </section>

    <section id="horizontal-bar">
      <div class="page-header">
        <h2>Horizontal Bar <small>used for comparing many values in a single series</small></h2>
      </div>
      <div class="row">
        <div class="span6">
          <h3>All Opportunities By Lead Source By Outcome</h3>
          <p>A horizontal bar chart with stacked data. <a href="charts/multiBarHorizontalChart_opportunities.html">Full Screen</a> showing graduated fill option and grouping option.</p>
          <div>
<div id="horiz1" class="nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
          <h3>Short/Long Horizontal Bar</h3>
          <p>A horizontal bar chart with grouped data for comparing series relative to a baseline. <a href="charts/multiBarHorizontalChart.html">Full Screen</a> showing gradient fill.</p>
          <div>
<div id="horiz2" class="nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
      </div>
    </section>

    <section id="vertical-bar">
      <div class="page-header">
        <h2>Vertical Bar <small>used for comparing multiple series with a few values</small></h2>
      </div>
      <div class="row">
        <div class="span6">
          <h3>Standard Vertical Bar Chart</h3>
          <p>Long description. <a href="charts/multiBarChart_sugar.html">Full Screen</a> with graduated fill and grouping option.</p></p>
          <div>
<div id="vert1" class="nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
          <h3>Pareto Chart</h3>
          <p>This is a new NVD3 chart type created for SugarCRM. An example of usage in the Sugar7 prototype is on <a href="../styleguide/sugar7/forecast_nvd3.html">forecasting page</a>. <a href="charts/multiBarChart_forecast.html">Full Screen</a> with gradient fill.</p>
          <div>
<div id="vert2" class="nv-chart view-forecastsChart">
  <svg></svg>
</div>
          </div>
        </div>
      </div>
    </section>

    <section id="circular">
      <div class="page-header">
        <h2>Circular Charts <small>used for comparing parts to a whole</small></h2>
      </div>
      <div class="row">
        <div class="span6">
          <h3>Pie Chart</h3>
          <p>Example pie chart. <a href="charts/pieChart.html">Full Screen</a></p>
          <div>
<div id="pie" class="nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
          <h3>Donut Chart</h3>
          <p>Example donut chart.</p>
          <div>
<div id="donut" class="nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
      </div>
    </section>

    <section id="custom">
      <div class="page-header">
        <h2>Custom Charts <small>used for comparing values in a process</small></h2>
      </div>
      <div class="row">
        <div class="span6">
          <h3>Pipeline By Sales Stage</h3>
          <p>This is a new NVD3 funnel chart type created for SugarCRM. <a href="charts/funnelChart.html">Full Screen</a></p>
          <div>
<div id="funnel1" class="nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
          <h3>Closed Won Opportunities</h3>
          <p>This is a new NVD3 gauge chart type created for SugarCRM. <a href="charts/gaugeChart.html">Full Screen</a></p>
          <div>
<div id="gauge" class="nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="span6">
          <h3>Treemap Chart</h3>
          <p>This is a new NVD3 treemap chart type created for SugarCRM. <a href="charts/treemapChart.html">Full Screen</a></p>
          <div>
<div id="treemap1" class="nv-treemap nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
          <h3>Opportunities</h3>
          <p>This is a new NVD3 treemap chart type created for SugarCRM. <a href="charts/treemapChart_opportunities.html">Full Screen</a></p>
          <div>
<div id="treemap2" class="nv-treemap nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
      </div>
    </section>

    <section id="implementation">

      <div class="page-header">
        <h2>Chart Implementation <small>Patterns for inserting and configuring charts.</small></h2>
      </div>

      <div class="row">

        <div class="span7">
          <h3>Simple Chart Instance</h3>
          <p>Creating new chart using default parameters and setting data model.</p>
<pre class="prettyprint linenums">
  &lt;div id="chart1"&gt;
    &lt;svg>&lt;/svg&gt;
  &lt;/div&gt;
  var chart = nv.models.multiBarChart();

  d3.select('#chart1 svg')
    .datum(forecast_data_Q1)
    .transition().duration(500).call(chart);
</pre>

          <h3>Overriding Base Event Handlers</h3>
          <p>Default chart handlers (if defined in chart class) can be overridden by passing a function on instantiation.</p>
<pre class="prettyprint linenums">
  var chart = nv.models.multiBarChart()
                .barClick( function(data,e,selection) {
                    d3.select('#chart1 svg')
                      .datum(forecast_data_Q2)
                      .transition().duration(500).call(chart);
                  }
                );
</pre>

          <h3>Setting Parameters</h3>
          <p>Chart parameters can be set by calling public getter/setter functions.</p>

<pre class="prettyprint linenums">
  var chart = nv.models.multiBarChart()
                .x(function(d) { return d.label })
                .y(function(d) { return d.value })
                .margin({top: 0, right: 0, bottom: 15, left: 90})
                .showValues(true)
                .tooltips(true)
                .showControls(false);
</pre>

          <h3>Instantiating Chart</h3>
          <p>A chart can be instantiated with generate and callback functions using NVD3 addGraph function.</p>
<pre class="prettyprint linenums">
    nv.addGraph({
      generate: function() {
          var chart = nv.models.multiBarChart();

          d3.select('#chart1 svg')
            .datum(forecast_data_Q1)
            .transition().duration(500).call(chart);

          nv.utils.windowResize(chart.update);

          return chart;
      },
      callback: function(graph) {
        $('#log').text('Chart is loaded');
      }
    });
</pre>
        </div> <!-- end col -->


        <div class="span5">

          <h3>Standard Parameters</h3>
          <p>This is a set of common chart parameters.</p>
          <div>
<table class="table table-bordered table-striped">
  <thead>
   <tr>
     <th style="width: 100px;">Name</th>
     <th style="width: 50px;">type</th>
     <th style="width: 50px;">default</th>
     <th>description</th>
   </tr>
  </thead>
  <tbody>
   <tr>
     <td>margin</td>
     <td>map</td>
     <td>varies</td>
     <td><code>{top: 20, right: 10, bottom: 40, left: 40}</code></td>
   </tr>
   <tr>
     <td>width | height</td>
     <td>numeric</td>
     <td>null</td>
     <td>set fixed width; null sets chart to expand to containing div</td>
   </tr>
   <tr>
     <td>getX | getY</td>
     <td>function</td>
     <td><code>function(d) { return d.x }</code></td>
     <td>how to get to the x,y property in the datum</td>
   </tr>
   <tr>
     <td>color</td>
     <td>function</td>
     <td><code>nv.utils.defaultColor()</code></td>
     <td>call to function to return color map</td>
   </tr>
   <tr>
     <td>showControls</td>
     <td>boolean</td>
     <td>false</td>
     <td>show chart controls if any</td>
   </tr>
   <tr>
     <td>showLegend</td>
     <td>boolean</td>
     <td>true</td>
     <td>show chart legend</td>
   </tr>
   <tr>
     <td>reduceXTicks | reduceYTicks</td>
     <td>boolean</td>
     <td>true</td>
     <td>if false a tick will show for every data point</td>
   </tr>
   <tr>
     <td>rotateLabels</td>
     <td>boolean</td>
     <td>false</td>
     <td>angle to rotate axis labels</td>
   </tr>
   <tr>
     <td>tooltips</td>
     <td>boolean</td>
     <td>true</td>
     <td>show tooltips over charting elements</td>
   </tr>
   <tr>
     <td>tooltip</td>
     <td>function</td>
     <td><code>function(key, x, y, e, graph) { return '&lt;h3&gt;' + key + ' - ' + x + '&lt;/h3&gt;' + '&lt;p&gt;' +  y + '&lt;/p&gt;'}</code></td>
     <td>function that returns an html formated string</td>
   </tr>
   <tr>
     <td>noData</td>
     <td>string</td>
     <td>"No Data Available."</td>
     <td>message to display when no data is available</td>
   </tr>
  </tbody>
</table>
          </div>
        </div> <!-- end col -->

      </div> <!-- end row -->

      <div class="row">
        <div class="span12">

          <h3>Binding Chart Data with Backbone</h3>
          <p>A chart can be bound to a common data model using Backbone.</p>
<pre class="prettyprint linenums">
  var Chart = Backbone.Model.extend({});
  var Charts = Backbone.Collection.extend({ model: Chart });
  charts = new Charts();
  charts.reset(forecast_data_Q1);

  // The chart view controls the single svg element on the screen
  var ChartsView = Backbone.View.extend({

    initialize: function() {
      // bind to model change events and use enter() to modify the appropriate circle
      var self = this;

      self.collection.bind(
        'reset',
        function(model)
        {
          d3.select(self.el)
            .datum( model.models.map( function(d,i){return d.attributes} ) )
            .transition().duration(500).call(self.chart);
        }
      );
    },

    render: function() {
      this.$el.empty();

      this.chart = nv.models.multiBarChart();

      d3.select(this.el)
        .datum( this.collection.models.map( function(d,i){return d.attributes} ) )
        .transition().duration(500).call(this.chart);

      nv.utils.windowResize(this.chart.update);

      return this;
    }

  });

  var chartsView = new ChartsView({ el: $('#chart1 svg'), collection: charts });
  chartsView.render();

  setTimeout(function() { charts.reset( forecast_data_Q2 ); },3000);
</pre>

        </div>
      </div>
    </section>

  </div>

  <!-- new D3 charting library files -->
  <script src="../assets/js/nvd3/lib/d3.v2.min.js"></script>
  <script src="../assets/js/nvd3/nv.d3.min.js"></script>
  <script src="js/underscore-min.js"></script>

  <script src="js/nvd3/data/forecasting_jit.js"></script>
  <script src="js/nvd3/data/vertical_data.js"></script>
  <script src="js/nvd3/data/opportunities.js"></script>
  <script src="js/nvd3/data/funnel_data.js"></script>
  <script src="js/nvd3/data/gauge_data.js"></script>
  <script src="js/nvd3/data/pie_data.js"></script>
  <script src="js/nvd3/data/line_data.js"></script>
  <script src="js/nvd3/data/horizbar_data.js"></script>
  <script src="js/nvd3/data/treemap_data.js"></script>
  <script src="js/nvd3/data/flare.js"></script>

  <script>
    //Vertical Bar Chart with Line
    nv.addGraph({
      generate: function() {
          //var chart = nv.models.multiBarChart();
          //override default barClick function
          var chart = nv.models.paretoChart()
                .margin({top: 10, right: 10, bottom: 30, left: 40})
                .showControls(false)
                .showTitle(false)
                .stacked(false)
                // .barClick( function(data,e,selection) {
                //     //if only one bar series is disabled
                //     // console.log(data);
                //     // console.log(e);
                //     // console.log(selection);
                //     d3.select('#vert2 svg')
                //       .datum(forecast_data_Q1)
                //       .transition().duration(500).call(chart);
                //   })
                ;
          //end override

          d3.select('#vert2 svg')
            .datum(this.translateDataToD3(forecast_data_Q1))
            .transition().duration(500).call(chart);

          return chart;
      },
      translateDataToD3 : function( json, params )
      {
          return {
              'properties':{
                  'title': json.properties[0].title
                , 'quota': parseInt(json.values[0].goalmarkervalue[0],10)
                // bar group data (x-axis)
                , 'groupData': json.values.map( function(d,i){
                      return {
                        'group': i
                      , 'l': json.values[i].label
                      , 't': json.values[i].values.reduce( function(p, c, i, a){
                          return parseInt(p,10) + parseInt(c,10);
                        })
                      }
                  })
              }
              // series data
            , 'data': json.label.map( function(d,i){
                  return {
                      'key': d
                    , 'type': 'bar'
                    , 'series': i
                    , 'values': json.values.map( function(e,j){
                          return { 'series': i, 'x': j+1, 'y': parseInt(e.values[i],10),  y0: 0 };
                      })
                    , 'valuesOrig': json.values.map( function(e,j){
                          return { 'series': i, 'x': j+1, 'y': parseInt(e.values[i],10),  y0: 0 };
                      })
                  }
              }).concat(
                  json.properties[0].goal_marker_label.filter( function(d,i){
                      return d !== 'Quota';
                    }).map( function(d,i){
                      return {
                          'key': d
                        , 'type': 'line'
                        , 'series': i
                        , 'values': json.values.map( function(e,j){
                            return { 'series': i, 'x': j+1, 'y': parseInt(e.goalmarkervalue[i+1],10) };
                          })
                        , 'valuesOrig': json.values.map( function(e,j){
                            return { 'series': i, 'x': j+1, 'y': parseInt(e.goalmarkervalue[i+1],10) };
                          })
                      }
                  })
              )
          };
      },
      callback: function(graph) {
        $('#log').text('Chart is loaded');
      }
    });

    // Vertical Bar Chart without Line
    nv.addGraph(function() {

      var chart = nv.models.multiBarChart()
            .showTitle(false)
            .tooltips(true)
            .showControls(false)
            //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#336699', l: forecast_data_Q1.data.length} )
            //.colorData( 'class' )
            .colorData( 'default' )
            //.colorFill( 'gradient' )
            .colorFill( 'default' )
            .tooltip( function(key, x, y, e, graph) {
                return '<p>Stage: <b>' + key + '</b></p>' +
                       '<p>Amount: <b>$' +  parseInt(y) + 'K</b></p>' +
                       '<p>Percent: <b>' +  x + '%</b></p>'
                })
            //.forceY([0,400]).forceX([0,6]);
          ;

      d3.select('#vert1 svg')
          .datum(vertical_data)
        .transition().duration(500)
          .call(chart);

      nv.utils.windowResize(chart.update);

      return chart;
    });

    // Multibar Horizontal Chart
    nv.addGraph({
      generate: function() {
        nv.addGraph(function() {
          var chart = nv.models.multiBarHorizontalChart()
                .x(function(d) { return d.label })
                .y(function(d) { return d.value })
                .margin({top: 10, right: 10, bottom: 20, left: 90})
                .showValues(true)
                .showTitle(false)
                .tooltips(true)
                .showControls(false)
                .tooltip( function(key, x, y, e, graph) {
                  return '<p>Outcome: <b>' + key + '</b></p>' +
                         '<p>Lead Source: <b>' +  x + '</b></p>' +
                         '<p>Amount: <b>$' +  parseInt(y) + 'K</b></p>'
                  })
              ;

          chart.yAxis
              .tickFormat(d3.format(',.2f'));

          d3.select('#horiz1 svg')
              .datum(opportunities_data)
            .transition().duration(500)
              .call(chart);

          return chart;
        });
      },
      callback: function(graph) {
        $('#log').text('Chart is loaded');
      }
    });

    // Multibar Horizontal Chart with Baseline
    nv.addGraph({
      generate: function() {
        nv.addGraph(function() {
          var chart = nv.models.multiBarHorizontalChart()
                .x(function(d) { return d.label })
                .y(function(d) { return d.value })
                .margin({top: 10, right: 10, bottom: 20, left: 80})
                .showValues(true)
                .showTitle(false)
                .tooltips(true)
                .showControls(false)
                .stacked(false)
                .tooltip( function(key, x, y, e, graph) {
                  return '<p>Outcome: <b>' + key + '</b></p>' +
                         '<p>Lead Source: <b>' +  x + '</b></p>' +
                         '<p>Amount: <b>$' +  parseInt(y) + 'K</b></p>'
                })
              ;

          chart.yAxis
              .tickFormat(d3.format(',.2f'));

          d3.select('#horiz2 svg')
              .datum(horizbar_data)
            .transition().duration(500)
              .call(chart);

          return chart;
        });
      },
      callback: function(graph) {
        $('#log').text('Chart is loaded');
      }
    });

    // Funnel Chart
    nv.addGraph(function() {
      var chart = nv.models.funnelChart()
            .showTitle(false)
            .tooltip( function(key, x, y, e, graph) {
                return '<p>Stage: <b>' + key + '</b></p>' +
                       '<p>Amount: <b>$' +  parseInt(y) + 'K</b></p>' +
                       '<p>Percent: <b>' +  x + '%</b></p>'
              })
          ;

      chart.yAxis
          .tickFormat(d3.format(',.1f'));

      d3.select('#funnel1 svg')
          .datum(funnel_data)
        .transition().duration(500)
          .call(chart);

      return chart;
    });

    // Gauge Chart
    nv.addGraph(function() {
      var gauge = nv.models.gaugeChart()
          .x(function(d) { return d.key })
          .y(function(d) { return d.y })
          .showLabels(true)
          .showTitle(false)
          .colorData( 'default' )
          .colorFill( 'gradient' )
          .ringWidth(50)
          .maxValue(9)
          .transitionMs(4000);

      d3.select("#gauge svg")
          .datum(gauge_data)
        .transition().duration(500)
          .call(gauge);

      return gauge;
    });

    // Pie Chart
    nv.addGraph(function() {
      var chart = nv.models.pieChart()
            .x(function(d) { return d.key })
            .y(function(d) { return d.value })
            .showLabels(true)
            .showTitle(false)
            //.color(d3.scale.category10().range())
            //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: pie_data.data.length} )
            //.colorData( 'class' )
            .colorData( 'default' )
            //.colorFill( 'gradient' )
            .colorFill( 'default' )
            .tooltip( function(key, x, y, e, graph) {
              return '<p>Stage: <b>' + key + '</b></p>' +
                     '<p>Amount: <b>$' +  parseInt(y) + 'K</b></p>' +
                     '<p>Percent: <b>' +  x + '%</b></p>'
              })
          ;

        d3.select("#pie svg")
            .datum(pie_data)
          .transition().duration(500)
            .call(chart);

      return chart;
    });

    // Donut Chart
    nv.addGraph(function() {
      var chart = nv.models.pieChart()
            .x(function(d) { return d.key })
            .y(function(d) { return d.value })
            .showLabels(true)
            .showTitle(false)
            .donut(true)
            .donutLabelsOutside(true)
            //.color(d3.scale.category10().range())
            //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: pie_data.data.length} )
            //.colorData( 'class' )
            .colorData( 'default' )
            //.colorFill( 'gradient' )
            .colorFill( 'default' )
            .tooltip( function(key, x, y, e, graph) {
              return '<p>Stage: <b>' + key + '</b></p>' +
                     '<p>Amount: <b>$' +  parseInt(y) + 'K</b></p>' +
                     '<p>Percent: <b>' +  x + '%</b></p>'
              })
          ;

        d3.select("#donut svg")
            .datum(pie_data)
          .transition().duration(1200)
            .call(chart);

      return chart;
    });

    // Line chart
    nv.addGraph(function() {
      var chart = nv.models.lineChart()
            .x(function(d) { return d[0] })
            .y(function(d) { return d[1] })
            .showTitle(false)
            .tooltips(true)
            .showControls(false)
            .tooltip( function(key, x, y, e, graph) {
                return '<p>Category: <b>' + key + '</b></p>' +
                       '<p>Amount: <b>$' +  parseInt(y) + 'M</b></p>' +
                       '<p>Date: <b>' +  x + '</b></p>'
              })
            //.forceY([0,400]).forceX([0,6]);
          ;

      chart.xAxis
          .tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

      chart.yAxis
          .axisLabel('Voltage (v)')
          .tickFormat(d3.format(',.2f'));

      d3.select('#line1 svg')
          .datum(line_data)
        .transition().duration(500)
          .call(chart);

      return chart;
    });

    // Stacked area chart
    nv.addGraph(function() {

      var chart = nv.models.stackedAreaChart()
            .x(function(d) { return d[0] })
            .y(function(d) { return d[1] })
            .tooltip( function(key, x, y, e, graph) {
                return '<p>Category: <b>' + key + '</b></p>' +
                       '<p>Amount: <b>$' +  parseInt(y) + 'M</b></p>' +
                       '<p>Date: <b>' +  x + '</b></p>'
              })
            .showTitle(false)
            .tooltips(true)
            .showControls(false)
            //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: line_data.data.length} )
            //.colorData( 'class' )
            .colorData( 'default' )
            //.colorFill( 'gradient' )
            .colorFill( 'default' )
            //.clipEdge(true)
          ;

      chart.xAxis
          .tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

      chart.yAxis
          .axisLabel('Expenditures ($)')
          .tickFormat(d3.format(',.2f'));

      d3.select('#area svg')
          .datum(line_data)
        .transition().duration(500)
          .call(chart);

      return chart;
    });

    // Treemap flare chart
    nv.addGraph(function() {

      var chart = nv.models.treemapChart()
            .leafClick( function(d) {
                alert('leaf clicked');
            })
            .useClass(true)
            .showTitle(false)
            .tooltips(true)
            .getSize(function(d) { return d.size; })
            .className(function(d,i) {
              var m = chart.groups().indexOf(d.parent.name) % 20;
              return 'nv-fill' + (m>9?'':'0') + m%20;
            })
            //.showControls(false)
            //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: chartData.data.length} )
            //.colorData( 'class' )
            //.colorData( 'default' )
            //.colorFill( 'gradient' )
            //.colorFill( 'default' )
        ;

      d3.select('#treemap1 svg')
          .datum(flare_data)
        .transition().duration(500)
          .call(chart);

      return chart;
    });

    // Treemap opportunities chart
    nv.addGraph(function() {

      var root = {
          name: "Opportunities",
          children: [],
          x: 0,
          y: 0,
          dx: parseInt($('#treemap2 svg').width(), 10),
          dy: parseInt($('#treemap2 svg').height(), 10),
          depth: 0
      };

      root.children = parseData( treemap_data.records );

      var chart = nv.models.treemapChart()
            .leafClick( function(d) {
                // var model = app.data.createBean(self.module);
                // model.set("id", d.id);
                // model.fetch();
                // app.navigate(self.context, model);
                alert('leaf clicked');
            })
            .useClass(true)
            .showTitle(false)
            .tooltips(true)
            .tooltipContent( function(point) {
                var rep = (point.assigned_user_name) ? point.assigned_user_name : (point.className) ? point.parent.name : point.name,
                    stage = (point.sales_stage) ? point.sales_stage : (point.className) ? point.name : null,
                    account = (point.account_name) ? point.account_name : null;
                var tt = '<h4>Amount: <b>$' + d3.format(',.2s')(point.value) + '</b></h4>' +
                  '<p>Sales Rep: <b>' + rep + '</b></p>';
                if (stage) tt += '<p>Stage: <b>' +  stage + '</b></p>';
                if (account) tt += '<p>Account: <b>' +  account + '</b></p>';
                return tt;
            })
            .getSize(function(d) { return d.value; })
            .className(function(d) { return d.className; })
            //.showControls(false)
            //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: chartData.data.length} )
            //.colorData( 'class' )
            //.colorData( 'default' )
            //.colorFill( 'gradient' )
            //.colorFill( 'default' )
          ;

      d3.select('#treemap2 svg')
          .datum(root)
        .transition().duration(500)
          .call(chart);

      function parseData(data) {
        var today = new Date();
            today.setUTCHours(0,0,0,0);

        var day_ms = 1000*60*60*24
          , d1 = new Date(today.getTime() + 31*day_ms)
          , root = {
                children: []
            };

        data = data.filter(function(model) {
            // Filter for 30 days from now.
            var d2 = new Date(model.date_closed || "1970-01-01");
            return (d2-d1)/day_ms <= 30;
        }).map(function(d){
            // Include properties to be included in leaves
            return {
              assigned_user_name: d.assigned_user_name,
              sales_stage: d.sales_stage,
              name: d.name,
              amount_usdollar: d.amount_usdollar
            };
        });

        data = _.groupBy(data, function(m) {
            return m.assigned_user_name;
        });

        _.each(data, function(value, key, list) {
            list[key] = _.groupBy(value, function(m) {
                return m.sales_stage;
            });
        });

        _.each(data, function(value1, key1) {
            var child = [];
            _.each(value1, function(value2, key2) {
                _.each(value2, function(record) {
                    record.className = 'stage_'+record.sales_stage.toLowerCase().replace(' ', '');
                    record.value = parseInt(record.amount_usdollar, 10);
                });
                child.push({
                    name: key2,
                    className: 'stage_'+key2.toLowerCase().replace(' ', ''),
                    children: value2
                });
            });

            root.children.push({
                name: key1,
                children: child
            });
        });

        function accumulate(d) {
            if(d.children) {
                return d.value = d.children.reduce(function(p, v) { return p + accumulate(v); }, 0);
            }
            return d.value;
        }

        accumulate(root);

        return root.children;
      }

      return chart;
    });
  </script>
</body>
</html>
