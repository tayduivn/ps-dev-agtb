<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=320" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Treemap Chart - Opportunities</title>
  <link href="../css/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../css/sugar.css" rel="stylesheet" type="text/css">
  <style>
    body {
      overflow-y:scroll;
      padding: 20px;
    }
    text {
      font: 12px sans-serif;
    }
    body.full-screen div.nv-chart {
      height: 500px;
      width: 700px;
    }
  </style>
</head>
<body class="full-screen">

<div id="treemap" class="nv-treemap nv-chart">
  <svg></svg>
</div>

<script src="../js/jquery-1.7.2.min.js"></script>
<script src="../js/underscore-min.js"></script>
<script src="../js/backbone-min.js"></script>
<script src="../../assets/js/nvd3/lib/d3.v2.min.js"></script>
<script src="../../assets/js/nvd3/nv.d3.min.js"></script>
<script src="data/treemap_data.js"></script>
<script src="../js/nvd3/src/models/treemap.js"></script>
<script src="../js/nvd3/src/models/treemapChart.js"></script>

<script>
  var Chart = Backbone.Model.extend({});
  var Charts = Backbone.Collection.extend({ model: Chart });
  charts = new Charts();

  // The chart view controls the single svg element on the screen
  var ChartsView = Backbone.View.extend({

    initialize: function() {
      // bind to model change events and use enter() to modify the appropriate circle
      var self = this;

      self.collection.bind( 'reset', function(model) {

          var root = {
              name: "Opportunities",
              children: [],
              x: 0,
              y: 0,
              dx: parseInt(self.$el.width(), 10),
              dy: parseInt(self.$el.height(), 10),
              depth: 0
          };

          root.children = self.parseData( model.models.map( function(d,i){return d.attributes} )[0].records );

          d3.select(self.el)
            .datum( root )
            .transition().duration(500).call(self.chart);
      });
    },

    render: function() {
        var self = this;

        this.$el.show();

        this.chart = nv.models.treemapChart()
              .leafClick( function(d) {
                  // var model = app.data.createBean(self.module);
                  // model.set("id", d.id);
                  // model.fetch();
                  // app.navigate(self.context, model);
                  alert('leaf clicked');
              })
              .showTitle(false)
              .tooltips(true)
              .tooltipContent(function(point) {
                  var rep = (point.assigned_user_name) ? point.assigned_user_name : (point.className) ? point.parent.name : point.name,
                      stage = (point.sales_stage) ? point.sales_stage : (point.className) ? point.name : null,
                      account = (point.account_name) ? point.account_name : null;
                  var tt = '<h4>Amount: <b>$' + d3.format(',.2s')(point.value) + '</b></h4>' +
                    '<p>Sales Rep: <b>' + rep + '</b></p>';
                  if (stage) tt += '<p>Stage: <b>' +  stage + '</b></p>';
                  if (account) tt += '<p>Account: <b>' +  account + '</b></p>';
                  return tt;
              })
              .getSize(function(d) { return d.value; })
              //.className(function(d) { return d.className; })
              //.showControls(false)
              //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a'} )
              //.colorData( 'class' )
              .colorData( 'default', {gradient:true, orientation: 'horizontal'} )
          ;

        nv.utils.windowResize(this.chart.update);

        return this;
    },

    parseData: function(data) {
      var today = new Date();
          today.setUTCHours(0,0,0,0);

      var day_ms = 1000*60*60*24
        , d1 = new Date(today.getTime() + 31*day_ms)
        , root = {
              children: []
          };

      var data = data.filter(function(model) {
          // Filter for 30 days from now.
          var d2 = new Date(model.date_closed || "1970-01-01");
          return (d2-d1)/day_ms <= 30;
      }).map(function(d){
          // Include properties to be included in leaves
          return {
            assigned_user_name: d.assigned_user_name,
            sales_stage: d.sales_stage,
            name: d.name,
            amount_usdollar: d.amount_usdollar
          };
      });

      data = _.groupBy(data, function(m) {
          return m.assigned_user_name;
      });

      _.each(data, function(value, key, list) {
          list[key] = _.groupBy(value, function(m) {
              return m.sales_stage;
          });
      });

      _.each(data, function(value1, key1) {
          var child = [];
          _.each(value1, function(value2, key2) {
              _.each(value2, function(record) {
                  record.className = 'stage_'+record.sales_stage.toLowerCase().replace(' ', '');
                  record.value = parseInt(record.amount_usdollar, 10);
              });
              child.push({
                  name: key2,
                  className: 'stage_'+key2.toLowerCase().replace(' ', ''),
                  children: value2
              });
          });

          root.children.push({
              name: key1,
              children: child
          });
      });

      function accumulate(d) {
          if(d.children) {
              return d.value = d.children.reduce(function(p, v) { return p + accumulate(v); }, 0);
          }
          return d.value;
      }

      accumulate(root);

      return root.children;
    }

  });

  var chartsView = new ChartsView({ el: $('#treemap svg'), collection: charts });
  chartsView.render();
  charts.reset(treemap_data_default);

</script>
</body>
</html>
